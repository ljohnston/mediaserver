---

# - debug:
#     msg: "UUID={{ ansible_devices[item.name.split('/')[-1]].partitions[item.name.split('/')[-1] + '1'].uuid }}"
#   with_items:
#       - { "name": "/dev/sdb" }

- name: 'partition drives'
  parted:
      device: "{{ item.device }}"
      number: 1
      label: gpt
      state: present
  loop: "{{ devices | flatten(levels=1) }}"

- name: 'create filesystems'
  filesystem:
      dev: "{{ item.device }}1"
      fstype: "{{ item.fs_type }}"
      opts:  "{{ item.fs_opts  }}"
  loop: "{{ devices | flatten(levels=1) }}"

- name: 'create mount points'
  file:
      path: "{{ item.mount_point }}"
      state: directory
  loop: "{{ devices | flatten(levels=1) }}"

# Re-read facts to get new partition data for our UUID mounts.
- name: 're-read facts'
  setup:
      filter: 'ansible_devices'

- name: 'create mounts'
  mount:
      path: "{{ item.mount_point }}"
      src: "UUID={{ ansible_devices[item.device.split('/')[-1]].partitions[item.device.split('/')[-1] + '1'].uuid }}" 
      fstype: "{{ item.fs_type }}"
      state: mounted
  loop: "{{ devices | flatten(levels=1) }}"



