---
# ansible-playbook main.yml -i hosts --tags docker_apps -K
# the binary | this.file | -i targets | *optional --tags | -K asks for sudo pass

- hosts: all
  become: yes

  # Little hackery going on here. Ansible requires python2.7, but Xenial comes
  # without python installed. We can fix that with a "pre_task" (see below),
  # but simply collecting facts requires ansible and python. So we'll turn off
  # facts and then run the "setup" task (which gathers facts) as a "pre_task"
  # after installing python.
  gather_facts: false

  pre_tasks:
    - name: 'Install python 2.7 for Ansible'
      raw: test -e /usr/bin/python || (apt -y update && apt install -y python-minimal)
      register: output
      changed_when: output.stdout != ''
    - name: 'install python-apt'
      apt:
        pkg: '{{ samba__base_packages }}'
        state: 'present'
    - setup:
      tags:
        - always

    # We'll also install our any galaxy roles here.
    # This doesn't work... ansible "compiles" the playbook and dies if these
    # aren't there.
    # - name: 'install ansible-galaxy roles'
    #   command: 'ansible-galaxy install -r requirements.yml --roles-path roles.galaxy'
    #   delegate_to: localhost
    #   become: no
    #   register: galaxy_roles
    #   changed_when: '"was installed successfully" in galaxy_roles.stdout'

  roles:
    - { role: 'roles.galaxy/geerlingguy.docker', tags: 'docker' }
    - { role: 'roles.galaxy/geerlingguy.ntp',    tags: 'ntp' }

    - { role: 'filesystems', tags: 'filesystems' }
    - { role: 'snapraid',    tags: 'snapraid' }
    - { role: 'mergerfs',    tags: 'mergerfs' }
    - { role: 'mediaserver', tags: 'mediaserver' }
    - { role: 'samba',       tags: 'samba' }
